<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Post History</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/water.css@2/out/water.css">
    <style>
        .status-scheduled, .status-pending { color: #FFA500; }
        .status-success { color: #008000; }
        .status-failed { color: #FF0000; }
        .post-card { border: 1px solid #ddd; padding: 1rem; margin-bottom: 1rem; border-radius: 4px; }
        .post-image { max-width: 200px; max-height: 200px; object-fit: contain; display: block; margin-top: 1rem;}
        .actions button { margin-right: 0.5rem; padding: 0.5rem 1rem; cursor: pointer; }
        .edit-form { margin-top: 1rem; border-top: 1px dashed #ccc; padding-top: 1rem; }
    </style>
</head>
<body>
    <h1>Your Scheduled Posts</h1>

    <nav>
        <a href="http://localhost:5500/register.html" id="registerLink">Register</a> |
        <a href="#" id="logoutLink">Logout</a> |
        <a href="http://localhost:5500/dashboard.html" id="dashboardLink">Schedule New Post</a> |
        <a href="http://localhost:5500/history.html" id="historyLink">View History</a>
    </nav>

    <div id="message" style="display: none;"></div>

    <div id="posts-container">
        <p>Loading your post history...</p>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/persian-date@1.1.0/dist/persian-date.min.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/persian-datepicker@1.2.0/dist/js/persian-datepicker.min.js"></script>


    <script>
        function showMessage(text, style) {
            const messageDiv = document.getElementById('message');
            messageDiv.textContent = text;
            messageDiv.style = `display: block; padding: 1rem; margin: 1rem 0; border-radius: 4px; ${style}`;
            setTimeout(() => {
                messageDiv.style.display = 'none';
            }, 5000);
        }

        async function fetchPosts() {
            const userName = localStorage.getItem("user_name");
            if (!userName) {
                showMessage('You are not logged in. Redirecting to login...', 'background: #ffebee; color: #b71c1c;');
                document.getElementById('posts-container').innerHTML = '<p>Please log in to view your post history.</p>';
                setTimeout(() => {
                    window.location.href = 'http://localhost:5500/login.html?next=history.html';
                }, 1500);
                return;
            }

            try {
                const response = await fetch(`http://localhost:5000/history`, {
                    headers: { 'Accept': 'application/json' },
                    credentials: "include",
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || 'Failed to fetch post history.');
                }

                const posts = await response.json();
                const postsContainer = document.getElementById('posts-container');
                postsContainer.innerHTML = '';

                if (posts.length === 0) {
                    postsContainer.innerHTML = '<p>No posts scheduled yet.</p>';
                    return;
                }

                posts.forEach(post => {
                    const postCard = document.createElement('div');
                    postCard.className = 'post-card';
                    postCard.dataset.postId = post.id;
                    let statusClass = '';

                    if (post.status === 'scheduled' || post.task_status === 'PENDING' || post.task_status === 'STARTED') {
                        statusClass = 'status-scheduled';
                    } else if (post.status === 'success' || post.task_status === 'SUCCESS') {
                        statusClass = 'status-success';
                    } else if (post.status === 'failed' || post.task_status === 'FAILURE') {
                        statusClass = 'status-failed';
                    }

                    postCard.innerHTML = `
                        <h3>Post ID: ${post.id}</h3>
                        <p><strong>Scheduled Time (Jalali):</strong> ${post.jalali_scheduled}</p>
                        <p><strong>Caption:</strong> ${post.caption}</p>
                        <p><strong>Status:</strong> <span class="${statusClass}">${post.status}</span></p>
                        ${post.error ? `<p style="color: red;"><strong>Error:</strong> ${post.error}</p>` : ''}
                        ${post.instagram_post_id ? `<p><strong>Instagram Post ID:</strong> ${post.instagram_post_id}</p>` : ''}
                        ${post.path ? `<img src="http://localhost:5000/static/${post.path}" alt="Post Image" class="post-image">` : ''}
                        <div class="actions">
                            <button class="delete-btn" data-id="${post.id}">Delete</button>
                            <button class="edit-btn" data-id="${post.id}">Edit</button>
                        </div>
                        <div id="edit-form-${post.id}" class="edit-form" style="display: none;">
                            <h4>Edit Post ${post.id}</h4>
                            <form id="editPostForm-${post.id}" enctype="multipart/form-data">
                                <label for="edit-image-${post.id}">Change Image (optional)</label>
                                <input type="file" id="edit-image-${post.id}" name="photo" accept="image/png, image/jpeg, image/jpg, image/gif">
                                <img id="edit-preview-${post.id}" src="http://localhost:5000/static/${post.path}" alt="Current Image" style="max-width: 150px; max-height: 150px; ${post.path ? 'display: block;' : 'display: none;'} margin-top: 0.5rem;">
                                <label for="edit-caption-${post.id}">New Caption</label>
                                <textarea id="edit-caption-${post.id}" name="caption">${post.caption || ''}</textarea>
                                <label for="edit-jalali-date-${post.id}">New Schedule Date (Jalali)</label>
                                <input type="text" id="edit-jalali-date-${post.id}" name="jalali_date" value="${post.jalali_scheduled ? post.jalali_scheduled.split(' ')[0] : ''}">
                                <label for="edit-schedule-time-${post.id}">New Schedule Time</label>
                                <input type="time" id="edit-schedule-time-${post.id}" name="schedule_time" value="${post.jalali_scheduled ? post.jalali_scheduled.split(' ')[1] : ''}">
                                <button type="submit">Save Changes</button>
                                <button type="button" class="cancel-edit-btn" data-id="${post.id}">Cancel</button>
                            </form>
                        </div>
                    `;
                    postsContainer.appendChild(postCard);

                    $(`#edit-jalali-date-${post.id}`).pDatepicker({
                        format: "YYYY-MM-DD",
                        autoClose: true,
                        initialValue: false
                    });

                    document.getElementById(`edit-image-${post.id}`).addEventListener('change', function(e) {
                        const preview = document.getElementById(`edit-preview-${post.id}`);
                        const file = e.target.files[0];
                        if (file) {
                            const reader = new FileReader();
                            reader.onload = function(e) {
                                preview.src = e.target.result;
                                preview.style.display = 'block';
                            }
                            reader.readAsDataURL(file);
                        } else {
                            preview.src = `http://localhost:5000/static/${post.path}`;
                            if (!post.path) preview.style.display = 'none';
                        }
                    });
                });
                attachEventListeners();
            } catch (error) {
                console.error('Error fetching post history:', error);
                showMessage(`Failed to load post history: ${error.message}`, 'background: #ffebee; color: #b71c1c;');
            }
        }

        function attachEventListeners() {
            // Delete Post
            document.querySelectorAll('.delete-btn').forEach(button => {
                button.addEventListener('click', async (e) => {
                    const postId = e.target.dataset.id;
                    if (!confirm(`Are you sure you want to delete post ${postId}?`)) {
                        return;
                    }

                    try {
                        // Corrected URL
                        const response = await fetch(`http://localhost:5000/post/${postId}/delete`, {
                            method: 'DELETE',
                            credentials: 'include'
                        });
                        const result = await response.json();
                        if (response.ok) {
                            showMessage(result.message, 'background: #e6f9e6; color: #006400;');
                            fetchPosts();
                        } else {
                            showMessage(result.message || 'Failed to delete post.', 'background: #ffebee; color: #b71c1c;');
                        }
                    } catch (error) {
                        showMessage('An error occurred during deletion.', 'background: #ffebee; color: #b71c1c;');
                        console.error('Delete error:', error);
                    }
                });
            });

            document.querySelectorAll('.edit-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const postId = e.target.dataset.id;
                    const editForm = document.getElementById(`edit-form-${postId}`);
                    editForm.style.display = editForm.style.display === 'none' ? 'block' : 'none';
                });
            });

            // Cancel Edit
            document.querySelectorAll('.cancel-edit-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const postId = e.target.dataset.id;
                    const editForm = document.getElementById(`edit-form-${postId}`);
                    editForm.style.display = 'none';
                });
            });

            // Handle Edit Form Submission
            document.querySelectorAll('.edit-form form').forEach(form => {
                form.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const postId = e.target.closest('.post-card').dataset.postId;
                    if (!postId) {
                        showMessage('Error: Could not find post ID.', 'background: #ffebee; color: #b71c1c;');
                        return;
                    }

                    const formData = new FormData(e.target);

                    try {
                        // Corrected URL
                        const response = await fetch(`http://localhost:5000/post/${postId}/edit`, {
                            method: 'PATCH',
                            body: formData,
                            credentials: 'include'
                        });
                        const result = await response.json();
                        if (response.ok) {
                            showMessage(result.message, 'background: #e6f9e6; color: #006400;');
                            document.getElementById(`edit-form-${postId}`).style.display = 'none';
                            fetchPosts();
                        } else {
                            showMessage(result.message || 'Failed to update post.', 'background: #ffebee; color: #b71c1c;');
                        }
                    } catch (error) {
                        showMessage('An error occurred during update.', 'background: #ffebee; color: #b71c1c;');
                        console.error('Edit error:', error);
                    }
                });
            });
        }

        // Handle Logout
        const logoutLink = document.getElementById('logoutLink');
        if (logoutLink) {
            logoutLink.addEventListener('click', async (e) => {
                e.preventDefault();
                try {
                    const response = await fetch('http://localhost:5000/logout', {
                        method: 'POST',
                        credentials: 'include'
                    });
                    const data = await response.json();
                    if (response.ok) {
                        alert(data.message);
                        localStorage.removeItem("user_name");
                        window.location.href = 'http://localhost:5500/login.html';
                    } else {
                        alert(data.message || 'Logout failed.');
                    }
                } catch (error) {
                    console.error('Logout error:', error);
                    alert('An error occurred during logout.');
                }
            });
        }
        
        document.addEventListener('DOMContentLoaded', fetchPosts);
    </script>
</body>
</html>